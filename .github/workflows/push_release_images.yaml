name: Build and Push Docker Image
env:
  IMAGE_NAME: nodebuilder
on:
  release:
    types: [ prereleased, published ]
  workflow_dispatch:
  pull_request:
    branches: [ push_docker_images_test ]
jobs:
  build-and-push:
    name : Push ${{ matrix.container }} image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        container:
          - alpine
          - amazon
          - arch
          - debian
          - fedora
          - manjaro
          - redhat
          - opensuse
    steps:
    - name: Checkout with history to get latest tag
      if: ${{ github.event_name != 'release' }}
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Find nodebuilder version tag
      # If the event is a release, get the tag from GITHUB_REF
      # Otherwise, find the most recent release tag instead of using the commit SHA
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          echo "NODEBUILDER_VERSION=${GITHUB_REF#refs/tags/}" >> "${GITHUB_ENV}"
        else
          echo "NODEBUILDER_VERSION=$(git describe --tags --abbrev=0)" >> "${GITHUB_ENV}"
        fi
    - name: Checkout the latest release tag
      uses: actions/checkout@v4
      with:
        ref: ${{ env.NODEBUILDER_VERSION }}
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Set container image tags
      # Set the tags for the container and container-version
      run: |
        TAGS="${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ matrix.container }}-${{ env.NODEBUILDER_VERSION }}"
        TAGS="${TAGS},${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ matrix.container }}"
        echo "IMAGE_TAGS=${TAGS}" >> "${GITHUB_ENV}"
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: docker/Dockerfile_${{ matrix.container }}
        push: ${{ !github.event.release.prerelease }}
        tags: ${{ env.IMAGE_TAGS }}
    - name: Build and push Ubuntu Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: docker/Dockerfile_ubuntu
        push: ${{ !github.event.release.prerelease }}
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:ubuntu-${{ env.NODEBUILDER_VERSION }}
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:ubuntu
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.NODEBUILDER_VERSION }}
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
